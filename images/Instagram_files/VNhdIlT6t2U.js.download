;/*FB_PKG_DELIM*/

__d("LSIssuePointQueryRestoreTask",["LSArrayGetObjectAt","LSBase64Encode.nop","LSIsEncryptionVersionSecure","LSIssueNewTaskAndGetTaskID","LSLogMebClientEvent.nop","LSLogWebQpl.nop","LSQplAnnotateString.nop","LSQplMarkPoint.nop","LSQplStartTrace.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][issuePointQueryRestoreTask] Beginning execution."),d[1]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsIssuePointQueryRestoreTaskStoredProcedure] Point query restore v2 is enabled"),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[14]=new c.Map(),d[14].set("error_msg","Expected a nonempty query result"),d[14].set("code",c.i64.cast([0,3])),d[14].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[15]=c.createArray(),d[16]=(d[15].push(d[14]),d[15]),e=[void 0,d[15]],d[2]=e[0],d[3]=e[1]):(b=a.item,d[14]=new c.Map(),d[14].set("backup_id",b.backupId),d[14].set("device_public_key_blob",b.devicePublicKeyBlob),d[14].set("device_private_key_blob",b.devicePrivateKeyBlob),d[14].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[14].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[14].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[14].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[14].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[14].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[14].set("orf_client_state_v2_blob",void 0),d[14].set("orf_v2_authority_level",void 0),d[14].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[14].set("device_id",b.deviceId),d[14].set("backup_tenancy",b.backupTenancy),d[14].set("encryption_version",b.encryptionVersion),d[14].set("revision_version",b.revisionVersion),d[14].set("initialize_restore_result",void 0),d[14].set("device_creation_timestamp_sec",void 0),d[14].set("authority_level",b.authorityLevel),e=[d[14],void 0],d[2]=e[0],d[3]=e[1])})},function(e){return d[5]=new c.Map(),d[5].set("value",d[2]),d[5].set("errors",d[3]),d[6]=d[5].get("value"),d[6]!==void 0?c.sequence([function(e){return d[14]=d[6].get("backup_id"),d[15]=d[6].get("device_public_key_blob"),d[16]=d[6].get("device_private_key_blob"),d[17]=d[6].get("epoch_storage_public_key_blob"),d[18]=d[6].get("epoch_storage_private_key_blob"),d[19]=d[6].get("epoch_auth_public_key_blob"),d[20]=d[6].get("epoch_auth_private_key_blob"),d[21]=d[6].get("mailbox_root_key_blob"),d[22]=d[6].get("ocmf_client_state_blob"),d[23]=d[6].get("orf_client_state_v2_blob"),d[24]=d[6].get("orf_v2_authority_level"),d[25]=d[6].get("oblivious_validation_token_blob"),d[26]=d[6].get("device_id"),d[27]=d[6].get("backup_tenancy"),d[28]=d[6].get("encryption_version"),d[29]=d[6].get("revision_version"),d[30]=d[6].get("initialize_restore_result"),d[31]=d[6].get("device_creation_timestamp_sec"),d[32]=d[6].get("authority_level"),c.i64.neq(d[26],void 0)?c.sequence([function(a){return d[34]=void 0,c.i64.neq(d[34],void 0)?c.resolve(d[35]=d[34]):c.sequence([function(a){return d[60]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[61]=a[0],a})},function(a){return d[61]?d[70]=(d[60].push(c.i64.cast([0,0])),d[60]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[62]=a[0],a})},function(a){return d[62]?d[70]=(d[60].push(c.i64.cast([0,2])),d[60]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[63]=a[0],a})},function(a){return d[63]?d[70]=(d[60].push(c.i64.cast([0,3])),d[60]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[64]=a[0],a})},function(a){return d[64]?d[70]=(d[60].push(c.i64.cast([0,4])),d[60]):0,d[65]=c.createArray(),d[66]=c.i64.of_int32(d[60].length),c.i64.gt(d[66],c.i64.cast([0,0]))?c.loopAsync(d[66],function(a){return d[70]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[60],d[70]).then(function(a){return a=a,d[71]=a[0],d[72]=a[1],a})},function(a){return d[73]=(d[65].push(d[71]),d[65])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[70]=c.createArray(),d[71]=c.i64.of_int32(d[65].length),c.i64.gt(d[71],c.i64.cast([0,0]))?c.loopAsync(d[71],function(a){return d[73]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[65],d[73]).then(function(a){return a=a,d[74]=a[0],d[75]=a[1],a})},function(a){return d[76]=(d[70].push(c.i64.to_string(d[74])),d[70])}])}):c.resolve()},function(a){return d[72]=d[70].join(","),d[67]=d[72]}])},function(a){return d[65].some(function(a){return c.i64.eq(d[28],a)})?d[68]=d[28]:d[68]=void 0,c.i64.neq(d[68],void 0)?d[69]=d[68]:d[69]=void 0,d[35]=d[69]}])},function(e){return c.i64.neq(d[35],void 0)?d[36]=d[35]:d[36]=c.i64.cast([0,0]),c.i64.neq(d[27],void 0)?d[37]=d[27]:d[37]=c.i64.cast([0,1]),d[38]=c.i64.random(),d[39]=a[3]==null?c.i64.to_string(d[38]):a[3],d[39]!==void 0?c.nativeOperation(b("LSQplStartTrace.nop"),c.i64.cast([0,679677570]),d[39],!0,void 0):c.resolve()},function(a){return d[39]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679677570]),d[39],"issue_task"):c.resolve()},function(a){return d[39]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679677570]),d[39],"request_type","ENCRYPTED_BACKUPS_MESSAGE_POINT_QUERY"):c.resolve()},function(e){return d[40]=new c.Map(),d[40].set("act_thread_id",a[0]),d[40].set("request_id",d[39]),d[40].set("tam_thread_subtype",c.i64.cast([0,0])),d[40].set("mem_message_type",c.i64.cast([0,0])),d[40].set("source",a[4]),c.nativeOperation(b("LSBase64Encode.nop"),d[22]).then(function(a){return a=a,d[41]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[21]).then(function(a){return a=a,d[42]=a[0],a})},function(a){return d[43]=new c.Map(),d[43].set("ocmf_client_state_blob",d[41]==null?"":d[41]),d[43].set("mailbox_root_key",d[42]==null?"":d[42]),d[44]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[60]=(d[44].push(a.epochId),d[44])})},function(a){return d[58]="Queried locally available epochs. Count: ",d[45]=c.i64.of_int32(d[44].length),d[59]=c.i64.to_string(d[45]),d[46]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][MEBEpochClientUtils] ",d[46],d[58],d[46],d[59]].join("")),c.resolve()},function(e){return d[47]=new c.Map(),d[47].set("device_id",d[26]),d[47].set("raw_tokens",d[43]),d[47].set("locally_available_epochs",d[44]),d[48]=new c.Map(),d[48].set("reference_timestamp",a[2]),d[48].set("device_context",d[47]),d[48].set("message_id",a[1]),d[49]=new c.Map(),d[49].set("restore_context",d[40]),d[49].set("success",d[48]),c.i64.gt(c.i64.cast([0,0]),c.i64.cast([0,0]))?(d[60]=c.i64.of_float(Date.now()),d[50]=c.i64.add(d[60],c.i64.cast([0,0]))):d[50]=c.i64.cast([0,0]),d[51]=d[49].get("restore_context"),d[52]=d[49].get("success"),d[52]!==void 0?(d[60]=d[52].get("message_id"),d[53]=d[60]):d[53]="",d[54]=d[51].get("act_thread_id"),d[55]=":",d[56]=c.toJSON(d[49]),c.storedProcedure(b("LSIssueNewTaskAndGetTaskID"),["encrypted_backups_restore",d[55],d[54],d[55],d[53]].join(""),c.i64.cast([0,50035]),d[56],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,d[50],c.i64.cast([0,0])).then(function(a){return a=a,d[57]=a[0],a})},function(a){return d[33]=d[57]}]):c.sequence([function(e){return d[34]=new c.Map(),d[34].set("error_code",c.i64.cast([0,1])),d[34].set("error_message",""),d[34].set("stored_procedure","issuePointQueryRestoreTask"),d[35]=new c.Map(),d[35].set("act_thread_id",a[0]),d[36]=new c.Map(),d[36].set("restore_context",d[35]),d[36].set("failure",d[34]),c.i64.gt(c.i64.cast([0,0]),c.i64.cast([0,0]))?(d[45]=c.i64.of_float(Date.now()),d[37]=c.i64.add(d[45],c.i64.cast([0,0]))):d[37]=c.i64.cast([0,0]),d[38]=d[36].get("restore_context"),d[39]=d[36].get("success"),d[39]!==void 0?(d[45]=d[39].get("message_id"),d[40]=d[45]):d[40]="",d[41]=d[38].get("act_thread_id"),d[42]=":",d[43]=c.toJSON(d[36]),c.storedProcedure(b("LSIssueNewTaskAndGetTaskID"),["encrypted_backups_restore",d[42],d[41],d[42],d[40]].join(""),c.i64.cast([0,50035]),d[43],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,d[37],c.i64.cast([0,0])).then(function(a){return a=a,d[44]=a[0],a})},function(a){return d[33]=d[44]}])},function(a){return d[7]=d[33]}]):c.sequence([function(e){return d[14]=d[5].get("errors"),d[15]=d[5].get("errors"),d[16]=new c.Map(),d[16].set("error_code",c.i64.cast([0,1])),d[16].set("error_message",""),d[16].set("stored_procedure","issuePointQueryRestoreTask"),d[17]=new c.Map(),d[17].set("act_thread_id",a[0]),d[18]=new c.Map(),d[18].set("restore_context",d[17]),d[18].set("failure",d[16]),c.i64.gt(c.i64.cast([0,0]),c.i64.cast([0,0]))?(d[27]=c.i64.of_float(Date.now()),d[19]=c.i64.add(d[27],c.i64.cast([0,0]))):d[19]=c.i64.cast([0,0]),d[20]=d[18].get("restore_context"),d[21]=d[18].get("success"),d[21]!==void 0?(d[27]=d[21].get("message_id"),d[22]=d[27]):d[22]="",d[23]=d[20].get("act_thread_id"),d[24]=":",d[25]=c.toJSON(d[18]),c.storedProcedure(b("LSIssueNewTaskAndGetTaskID"),["encrypted_backups_restore",d[24],d[23],d[24],d[22]].join(""),c.i64.cast([0,50035]),d[25],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,d[19],c.i64.cast([0,0])).then(function(a){return a=a,d[26]=a[0],a})},function(a){return d[7]=d[26]}])},function(d){return a[3]!==void 0?c.nativeOperation(b("LSLogWebQpl.nop"),a[3],c.i64.cast([0,521476165]),"restore_task_start",c.i64.cast([0,1]),a[4],void 0):c.resolve()},function(a){return d[8]=c.i64.of_float(Date.now()),d[9]=c.i64.random(),d[11]="Finishing execution. Execution time: ",d[12]=c.i64.to_string(c.i64.sub(d[8],d[0])),d[13]=" ms",d[10]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][issuePointQueryRestoreTask] ",d[10],d[11],d[10],d[12],d[10],d[13]].join("")),c.i64.eq(c.i64.mod_(d[9],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[14]=",",d[15]=c.createArray(),void 0!==void 0?d[16]=(d[15].push(void 0),d[15]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"issuePointQueryRestoreTask",[d[11],d[14],d[12],d[14],d[13]].join(""),d[15],c.i64.cast([0,4]))):c.resolve()},function(a){return e[0]=d[7]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsIssuePointQueryRestoreTaskStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSIssuePointQueryRestoreTaskStoredProcedure",["LSIssuePointQueryRestoreTask","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSIssuePointQueryRestoreTask"),e.threadId,e.messageId,e.startSortKey,e.traceId,e.source);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MAWBridgeIssuePointQueryHandler",["EBIsEbEnabled","I64","LSFactory","LSIntEnum","LSIssuePointQueryRestoreTaskStoredProcedure","LSRequestId","MAWEBRestoreTrackingUtils","Promise","WAGetStorageQplAnnotations","emptyFunction","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(a){c("promiseDone")(d("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(b){d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:b,pointName:"storage_estimation_retrieved",traceId:a})}))}function a(a,c){return d("EBIsEbEnabled").isEbEnabledLS(a).then(function(d){return!d?(j||(j=b("Promise"))).resolve():l(a,c)})}function l(a,b){var e=c("LSRequestId").generate(),f=(h||(h=d("LSIntEnum"))).unwrapIntEnum((i||(i=d("I64"))).of_float(b.taskSource));d("MAWEBRestoreTrackingUtils").markEBRestorePoint(f,e,"LS");k(e);return c("LSIssuePointQueryRestoreTaskStoredProcedure")(c("LSFactory")(a),{messageId:b.messageId,source:h.ofNumber(f),startSortKey:b.startSortKey,threadId:b.threadId,traceId:e}).then(c("emptyFunction"))}g.call=a}),98);